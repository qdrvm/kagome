/**
 * Copyright Quadrivium LLC All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

#include <gtest/gtest.h>

#include "runtime/common/memory_allocator.hpp"
#include "scale/tie.hpp"
#include "testutil/runtime/memory.hpp"

using kagome::common::unhex;
using kagome::runtime::MemoryAllocator;
using kagome::runtime::MemoryAllocatorImpl;
using kagome::runtime::MemoryConfig;
using kagome::runtime::TestMemory;

struct Replay {
  SCALE_TIE(3);

  struct OpAllocate {
    SCALE_TIE(2);

    uint32_t size, ptr;
  };
  struct OpDeallocate {
    SCALE_TIE(1);

    uint32_t ptr;
  };
  using Op = boost::variant<OpAllocate, OpDeallocate>;

  uint32_t size, heap_base;
  std::vector<Op> ops;
};

void test(std::string_view hex) {
  auto replay = scale::decode<Replay>(unhex(hex).value()).value();

  TestMemory memory;
  memory.handle->resize(replay.size);
  MemoryAllocatorImpl allocator{memory.handle, MemoryConfig{replay.heap_base}};
  for (auto &op : replay.ops) {
    if (auto op_allocate = boost::get<Replay::OpAllocate>(&op)) {
      EXPECT_EQ(allocator.allocate(op_allocate->size), op_allocate->ptr);
    } else {
      auto &op_deallocate = boost::get<Replay::OpDeallocate>(op);
      allocator.deallocate(op_deallocate.ptr);
    }
  }
}

// Replay allocations captured from substrate
TEST(AllocatorTest, Test) {
  // clang-format off
  test("00002000303c1500711400ec010000383c1500003c000000403e1500006d000000883e15000072000000103f15000021000000983f15000020060000e03f1500006d000000e84715000050000000704815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000005000000104915000005000000204915000120491500011049150000200000003049150001304915000010000000f848150001f84815000010000000f848150001f8481500000b000000f848150000060000001049150001f848150001104915000010000000f848150001f84815000010000000f848150001f848150000080000001049150001104915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000180000003049150000080000001049150000740000005849150001104915000075000000e04915000130491500015849150001e04915000010000000f848150001f84815000010000000f848150001f848150000200000003049150001304915000010000000f848150001f84815000010000000f848150001f84815000008000000104915000110491500000c000000f8481500002c000000684a150001f8481500002000000030491500013049150001684a15000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000010000001049150001104915000010000000f848150001f84815000010000000f848150001f84815000078000000e0491500001400000030491500006d0000005849150001e0491500015849150001304915000010000000f848150001f84815000010000000f848150001f848150000010000001049150001104915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000054000000584915000050000000e049150001584915000050000000584915000010000000f848150001f84815000010000000f848150001f8481500000100000010491500011049150001e04915000008000000104915000022000000684a150001104915000044000000e049150001684a15000088000000b04a150001e04915000010000000f848150001f84815000010000000f848150001f84815000008000000104915000079000000e0491500011049150001e049150001b04a150001584915000010000000f848150001f84815000010000000f848150001f848150000010000001049150001104915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000010000001049150000080000002049150001104915000010000000f84815000120491500002000000030491500002e000000684a150001f848150001304915000040000000b84b1500006e0000005849150001684a150001b84b150001584915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000f1000000b04a15000028000000b84b1500006d000000584915000072000000e049150001b04a15000010000000f848150001f84815000010000000f848150001f84815000044000000004c15000040000000684a150001004c150001684a15000010000000f848150001f84815000010000000f848150001f84815000020000000304915000130491500015849150001e049150001b84b15000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f848150000200000003049150000080000002049150001204915000028000000b84b150001304915000054000000e049150001b84b150001f8481500000100000020491500012049150001e04915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000022000000b84b150001b84b15000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000040000000b84b150001b84b15000010000000f848150001f84815000010000000f848150001f8481500002e000000b84b150001b84b15000000020000884c15000060000000e04915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000020000000304915000010000000f848150001f84815000010000000f848150001f84815000022000000b84b150001b84b15000008000000204915000020000000904e15000025000000b84b1500012049150001904e1500004a0000005849150001b84b15000020000000904e15000094000000b04a1500015849150001904e15000020000000904e150001904e15000020000000904e150001904e150001b04a15000010000000f848150001f84815000010000000f848150001f84815000008000000204915000028000000b84b150001204915000020000000904e150001904e150001b84b15000008000000204915000020000000904e15000025000000b84b1500012049150001904e1500004a0000005849150001b84b15000020000000904e15000094000000b04a1500015849150001904e15000020000000904e150001904e1500000800000020491500007400000058491500012049150001b04a1500000f000000f84815000020000000904e1500002c000000b84b150001f848150001904e150001b84b1500015849150001884c15000010000000f848150001f84815000010000000f848150001f8481500013049150001e04915000008000000204915000020000000304915000025000000b84b150001204915000130491500004a000000e049150001b84b15000020000000304915000094000000b04a150001e049150001304915000020000000304915000130491500002000000030491500013049150001b04a15000008000000204915000020000000304915000021000000b84b1500012049150001304915000010000000f848150001f84815000010000000f848150001f84815000008000000204915000027000000684a1500012049150001684a150001b84b15000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000200000003049150001304915000010000000f848150001f84815000010000000f848150001f84815000071000000e049150001e04915000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000100000020491500012049150000080000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000001000000204915000120491500000800000020491500012049150000080000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000400000020491500000c000000f8481500012049150001f84815000010000000f848150001f84815000010000000f848150001f84815000020000000304915000010000000f848150001f84815000030000000b84b150001304915000050000000e049150001b84b1500005300000058491500015849150001e04915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f8481500002c000000b84b150001f8481500000100000020491500012049150001b84b15000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f8481500002c000000b84b150001f848150001b84b15000010000000f848150001f84815000010000000f848150001f848150000ca000000b04a150001b04a15000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000040000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000ca000000b04a150001b04a15000010000000f848150001f84815000010000000f848150001f84815000020000000304915000020000000904e15000022000000b84b15000020000000b84e150001b84b150001b84e150001904e150001304915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000080000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000008000000204915000010000000f8481500012049150001f84815000010000000f848150001f84815000010000000f848150001f8481500000800000020491500012049150001e847150001704815000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f8481500002c000000b84b150001f84815000022000000684a150001684a150001b84b15000088010000884c1500000b000000f848150001884c150000060000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000008000000204915000120491500000c000000e04e1500002c000000b84b150001e04e1500000f000000e04e150001e04e150001b84b150001f84815000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000f000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000008000000204915000010000000f8481500012049150001f84815000010000000f84815000010000000e04e150001f84815000010000000f84815000010000000f84e1500000100000020491500012049150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e1500000a000000e04e150001e04e1500000600000020491500012049150001f84815000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000070000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000008000000204915000010000000f8481500012049150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000080000002049150001204915000088010000884c1500002000000030491500013049150000200000003049150001304915000020000000304915000130491500006a0000007048150001884c150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f8481500002c000000b84b150001f8481500006e000000e847150001e847150001b84b150001704815000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000f000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000008000000204915000010000000f8481500012049150001f84815000010000000f84815000010000000e04e150001f84815000010000000f8481500000100000020491500012049150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000022000000b84b150001b84b15000020000000304915000020000000904e150001304915000040000000b84b150001904e15000020000000904e150000800000007048150001b84b150001904e15000020000000904e150001904e15000020000000904e150001904e150001704815000010000000e04e150001e04e15000010000000e04e150001e04e150000060000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000060000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000ca000000b04a150001b04a15000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000006000000204915000120491500002d000000b84b150001b84b15000010000000e04e150001e04e15000010000000e04e150001e04e150000030000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000ca000000b04a150001b04a15000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000044000000704815000040000000b84b150001704815000010000000e04e150001e04e15000010000000e04e150001e04e150000060000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000022000000684a150001684a15000010000000e04e150001e04e15000010000000e04e150001e04e1500000600000020491500012049150001b84b15000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000080000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000060000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000ca000000b04a150001b04a15000010000000e04e150001e04e15000010000000e04e150001e04e150000060000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000003000000204915000120491500001c000000904e15000010000000e04e150001e04e15000010000000e04e150001e04e15000020000000304915000020000000b84e15000022000000b84b15000020000000104f150001b84b150001104f150001b84e1500013049150001904e15000010000000e04e150001e04e15000010000000e04e150001e04e150000ca000000b04a150001b04a15000010000000e04e150001e04e15000010000000e04e150001e04e150000070000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000080000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000ca000000b04a150001b04a15000010000000e04e150001e04e15000010000000e04e150001e04e150000030000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000040000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000030000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000070000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000030000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000080000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000080000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000ca000000b04a150001b04a15000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e150000010000002049150001204915000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000010000000e04e150001e04e15000004000000204915000120491500000600000020491500012049150001f84815000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000070000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000008000000204915000010000000f8481500012049150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000800000020491500012049150001e03f150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000080000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000f000000f848150001f84815000010000000f848150001f84815000010000000f848150001f8481500000f000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000008000000204915000010000000f8481500012049150001f84815000010000000f848150001f84815000010000000f848150001f848150000710000007048150001704815000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000054000000704815000050000000e847150001704815000010000000f848150001f84815000010000000f848150001f8481500000a000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000100000020491500012049150001e84715000010000000f848150001f84815000010000000f848150001f84815000021000000b84b150001b84b15000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000030000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f8481500000f000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000020000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000040000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000010000002049150001204915000010000000f848150001f84815000010000000f848150001f848150000020000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000010000000f848150001f84815000010000000f848150001f84815000022000000b84b150001b84b15000010000000f848150001f84815000010000000f848150001f84815000018010000884c1500003c000000b84b1500006d000000e84715000072000000704815000021000000684a150001884c15000010000000f848150001f84815000010000000f848150001f848150000060000002049150001204915000018000000904e15000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f8481500002c000000384f150001f8481500000e000000f8481500000b000000e04e150001f848150001384f15000010000000f848150001f84815000010000000f848150001f84815000008000000204915000120491500000c000000f8481500002c000000384f150001f8481500006f000000e0491500006a0000005849150001e049150001384f1500001c000000304915000079000000e04915000130491500002000000030491500013049150001e049150001e04e1500015849150001904e15000020000000904e150001904e150001e8471500017048150001684a150001b84b150001883e150001103f150001983f150001403e1500");
  // clang-format on
}
