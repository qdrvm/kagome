#
# Copyright Soramitsu Co., Ltd. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#

add_library(assets
    assets.cpp
    )

find_program(ECHO echo)

if(EMBEDDINGS)
    set(SOURCE ${PROJECT_SOURCE_DIR}/examples/first_kagome_chain/localchain.json)
    if(NOT EXISTS ${SOURCE})
        fatal_error("Not found resource for embedded assets: ${SOURCE}")
    endif()
    set(OUTPUT embedded_chainspec.hpp)
    add_custom_command(
        OUTPUT ${OUTPUT}
        PRE_BUILD
        COMMAND ${ECHO} ARGS "// Embedded chain-spec. Generated by cmake from ${SOURCE}" > ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "#include <assets/assets.hpp>" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "namespace kagome::assets {" >> "${OUTPUT}"
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS -n "  const char *const embedded_chainspec = R\"%chainspec%\(" >> ${OUTPUT}
        COMMAND cat ARGS ${SOURCE} >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "\)%chainspec%\";" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "}  // namespace kagome::assets" >> ${OUTPUT}
        MAIN_DEPENDENCY ${SOURCE}
        DEPENDS ${SOURCE}
        COMMENT "Generating ${OUTPUT} with embedding chain spec"
        VERBATIM
        )
    target_sources(assets PRIVATE ${OUTPUT})

    set(SOURCE ${PROJECT_SOURCE_DIR}/examples/first_kagome_chain/base_path/chains/dev/keystore)
    if(NOT IS_DIRECTORY ${SOURCE})
        fatal_error("Not found resource for embedded assets: ${SOURCE}")
    endif()
    set(OUTPUT embedded_keys.hpp)
    add_custom_command(
        OUTPUT ${OUTPUT}
        PRE_BUILD
        COMMAND ${ECHO} ARGS "// Embedded keys. Generated by cmake from ${SOURCE}" > ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "#include <assets/assets.hpp>" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "#include <vector>" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "namespace kagome::assets {" >> "${OUTPUT}"
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "  const std::vector<std::pair<const char *, const char *>> embedded_keys{" >> ${OUTPUT}
        COMMAND sh ARGS -c "cd ${SOURCE};\
            for key in * ; do\
             ${ECHO} -n \"      {\\\"\";\
               ${ECHO} -n $key;\
             ${ECHO} \"\\\",\";\
             ${ECHO} -n \"       \\\"\";\
               cat $key;\
             ${ECHO} \"\\\"},\";\
            done"
            >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "  };" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "}  // namespace kagome::assets" >> ${OUTPUT}
        MAIN_DEPENDENCY ${SOURCE}
        DEPENDS ${SOURCE}
        COMMENT "Generating ${OUTPUT} with embedding keys"
        VERBATIM
        )
    target_sources(assets PRIVATE ${OUTPUT})
else()
    set(OUTPUT embedded_chainspec.hpp)
    add_custom_command(
        OUTPUT ${OUTPUT}
        PRE_BUILD
        COMMAND ${ECHO} ARGS "// Chain-spec was not embed. EMBEDDINGS option is OFF" > ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "#include <assets/assets.hpp>" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "namespace kagome::assets {" >> "${OUTPUT}"
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "  const char *const embedded_chainspec = nullptr;" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "}  // namespace kagome::assets" >> ${OUTPUT}
        COMMENT "Generating empty ${OUTPUT}"
        VERBATIM
    )
    target_sources(assets PRIVATE ${OUTPUT})

    set(OUTPUT embedded_keys.hpp)
    add_custom_command(
        OUTPUT ${OUTPUT}
        PRE_BUILD
        COMMAND ${ECHO} ARGS "// Keys was not embed. EMBEDDINGS option is OFF" > ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "#include <assets/assets.hpp>" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "#include <vector>" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "namespace kagome::assets {" >> "${OUTPUT}"
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "  const std::vector<std::pair<const char *, const char *>> embedded_keys;" >> ${OUTPUT}
        COMMAND ${ECHO} ARGS >> ${OUTPUT}
        COMMAND ${ECHO} ARGS "}  // namespace kagome::assets" >> ${OUTPUT}
        COMMENT "Generating empty ${OUTPUT}"
        VERBATIM
    )
    target_sources(assets PRIVATE ${OUTPUT})
endif()

target_include_directories(assets
    PRIVATE ${CMAKE_CURRENT_BINARY_DIR}
    )
target_sources(assets
    PRIVATE assets.cpp
    )
